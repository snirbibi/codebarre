<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Scanner EAN-13 Optimis√©</title>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<!-- Quagga2 -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
html, body {
    height: 100%;
    margin: 0;
}

body {
    display: flex;
    flex-direction: column;
}

.header-title {
    text-align: center;
    margin: 10px 0;
}

.icon-scan {
    font-size: 40px;
    color: #0d6efd;
}

/* --- Correction paysage : hauteur bas√©e sur --vh --- */
#camera {
    flex: 1;
    width: 100%;
    height: calc(var(--vh, 1vh) * 50);
    min-height: 250px;
    background-color: #000;
    position: relative;
    overflow: hidden;
}

#camera video, #camera canvas {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
}

.info-box-container {
    padding: 10px;
    background: #f8f9fa;
    display: none;
}

.info-box { 
    padding: 10px; 
    border-radius: 8px; 
    margin-bottom: 5px;
    word-break: break-word;
}

.fade-in { animation: fadeIn 0.5s ease-in; }
@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }

#result { font-weight: bold; color: #007bff; font-size: 20px; }

@media (max-width: 576px) {
    #result, #description, #price { font-size: 16px; }
    .icon-scan { font-size: 30px; }
}
</style>

<script>
// --- Fix hauteur de l'√©cran (corrige la disparition en paysage) ---
function fixViewportHeight() {
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
}

$(document).ready(function() {

    fixViewportHeight();
    window.addEventListener('resize', fixViewportHeight);
    window.addEventListener('orientationchange', () => {
        fixViewportHeight();
        Quagga.stop();
        setTimeout(startScanner, 800); // d√©lai augment√© pour stabilit√©
    });

    startScanner();
    $("#restartBtn").click(restartScanner);
});

function startScanner() {
    $(".info-box-container").hide();

    const width = window.innerWidth;
    const height = window.innerHeight * 0.5; // autrement plus fiable

    const config = {
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector("#camera"),
            constraints: {
                facingMode: { ideal: "environment" },
                width: { min: 320, ideal: width },
                height: { min: 240, ideal: height }
            }
        },
        decoder: { readers: ["ean_reader"] },
        locate: true
    };

    Quagga.init(config, function(err) {
        if (err) {
            console.error("Erreur init Quagga :", err);
            $("#result").text("Impossible d'initialiser la cam√©ra");
            return;
        }
        Quagga.start();
        $(".info-box-container").fadeIn(200);
    });

    Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        $("#result").text(code).addClass("fade-in");
		// V√©rifie si le code d√©tect√© est bien un code EAN-13 (longueur 13)
		if(code.length ==13)
			getItemFromServer(code);
    });
}

function restartScanner() {
    Quagga.stop();
    $("#result").text("Aucun");
    $("#description").text("En attente...");
    $("#price").text("En attente...");
    startScanner();
}

function getItemFromServer(codeBarre) {
    $.ajax({
        url: "/api/article",
        method: "POST",
        data: { codeBarre: codeBarre },
        success: function(response) {
            if (response.message === "OK") {
                $("#description").text(response.results.designation).addClass("fade-in");
                $("#price").text(response.results.prix + " ‚Ç¨").addClass("fade-in");
            } else {
                $("#description").text("Article non trouv√©");
                $("#price").text("N/A");
            }
        },
        error: function() {
            $("#description").text("Erreur serveur");
            $("#price").text("N/A");
        }
    });
}
</script>
</head>

<body>

<div class="header-title">
    <div class="icon-scan">üì∑</div>
    <h1>Scanner EAN-13</h1>
    <p class="text-muted">Lyc√©e de l'Europe ‚Äì Dunkerque</p>
</div>

<div id="camera"></div>

<div class="info-box-container">
    <div class="info-box">
        <p>Code d√©tect√© : <span id="result">Aucun</span></p>
        <p>Description : <span id="description">En attente...</span></p>
        <p>Prix : <span id="price">En attente...</span></p>
    </div>
    <button id="restartBtn" class="btn btn-warning w-100">Red√©marrer Scanner</button>
</div>

</body>
</html>
