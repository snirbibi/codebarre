<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Scanner EAN-13 Optimis√©</title>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<!-- Quagga2 -->
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
body { padding: 10px; }

#camera {
    position: relative;
    width: 100%;
    height: 50vh;       /* adaptatif pour mobile */
    max-height: 500px;
    overflow: hidden;
    background-color: #000;
}

.header-title { text-align: center; margin: 20px 0; }
.icon-scan { font-size: 50px; color: #0d6efd; }
.info-box { padding: 20px; background: #f8f9fa; border-radius: 8px; transition: all 0.5s ease; word-break: break-word; }
.fade-in { animation: fadeIn 0.5s ease-in; }
@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
#result { font-size: 22px; font-weight: bold; color: #007bff; }

@media (max-width: 576px) {
    #result, #description, #price { font-size: 18px; }
    .icon-scan { font-size: 40px; }
}
</style>

<script>
$(document).ready(function() {
    startScanner();
    $("#restartBtn").click(restartScanner);

    // Gestion rotation smartphone
    window.addEventListener('orientationchange', () => {
        Quagga.stop();
        setTimeout(startScanner, 300); // petit d√©lai pour que le navigateur ajuste les dimensions
    });
});

function startScanner() {
    const width = window.innerWidth > window.innerHeight ? window.innerWidth : window.innerHeight;
    const height = window.innerWidth > window.innerHeight ? window.innerHeight : window.innerWidth;

    const config = {
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector("#camera"),
            constraints: {
                facingMode: { ideal: "environment" },
                width: { min: 320, ideal: width },
                height: { min: 240, ideal: height }
            }
        },
        decoder: { readers: ["ean_reader"] },
        locate: true
    };

    Quagga.init(config, function(err) {
        if (err) {
            console.error("Erreur initialisation Quagga :", err);
            $("#result").text("Impossible d'initialiser le scanner !");
            return;
        }
        Quagga.start();
    });

    Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        $("#result").text(code).addClass("fade-in");
        getItemFromServer(code);
    });
}

function restartScanner() {
    Quagga.stop();
    $("#result").text("Aucun");
    $("#description").text("En attente...");
    $("#price").text("En attente...");
    startScanner();
}

function getItemFromServer(codeBarre) {
    $.ajax({
        url: "/api/article",
        method: "POST",
        data: { codeBarre: codeBarre },
        success: function(response) {
            if (response.message === "OK") {
                $("#description").text(response.results.designation).addClass("fade-in");
                $("#price").text(response.results.prix + " ‚Ç¨").addClass("fade-in");
            } else {
                $("#description").text("Article non trouv√©");
                $("#price").text("N/A");
            }
        },
        error: function() {
            $("#description").text("Erreur serveur");
            $("#price").text("N/A");
        }
    });
}
</script>
</head>

<body>
<div class="container">
    <div class="header-title">
        <div class="icon-scan">üì∑</div>
        <h1>Scanner de Codes-Barres EAN-13</h1>
        <p class="text-muted">Lyc√©e de l'Europe ‚Äì Dunkerque</p>
    </div>

    <div class="row">
        <div class="col-12 col-md-6">
            <div id="camera"></div>
        </div>
        <div class="col-12 col-md-6">
            <div class="info-box">
                <p>Code d√©tect√© : <span id="result">Aucun</span></p>
                <p>Description : <span id="description">En attente...</span></p>
                <p>Prix : <span id="price">En attente...</span></p>
            </div>
            <div class="info-box">
                <button id="restartBtn" class="btn btn-warning mt-3">Red√©marrer Scanner</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>
