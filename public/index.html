<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scanner EAN-13</title>

<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
html, body {
    height: 100%;
    margin: 0;
}
body {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.header-title {
    text-align: center;
    padding: 10px 0 15px;
    flex: 0 0 auto;
}
.icon-scan { font-size: 40px; color: #0d6efd; }

#main-content {
    flex: 1 1 auto;
    display: flex;
    flex-direction: row;
    overflow: hidden;
}

#camera {
    flex: 1;
    position: relative;
    background: #000;
    overflow: hidden;
}
#camera video,
#camera canvas {
    position: absolute;
    inset: 0;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
}

#info-box {
    flex: 1;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
    padding: 20px;
}

#info-box .info-text {
    flex: 1 1 auto;
    overflow-y: auto;
}

#info-box button {
    flex: 0 0 auto;
    margin-top: 10px;
}

/* --------- MOBILE XS --------- */
@media (max-width: 767px) {
    #main-content {
        flex-direction: column;
    }

    #camera {
        flex: 0 0 50vh; /* hauteur camÃ©ra fixe */
    }

    #info-box {
        flex: 1 1 auto; /* occupe le reste de lâ€™Ã©cran */
        padding: 10px;
    }

    #info-box .info-text {
        flex: 1 1 auto;
        overflow-y: auto; /* texte scrollable si nÃ©cessaire */
    }

    #info-box button {
        flex: 0 0 auto; /* bouton toujours visible */
    }
}
</style>
</head>

<body>

<div class="header-title">
    <div class="icon-scan">ðŸ“·</div>
    <h1 class="mb-0">Scanner EAN-13</h1>
    <p class="text-muted">LycÃ©e de l'Europe â€“ Dunkerque</p>
</div>

<div id="main-content">
    <div id="camera"></div>

    <div id="info-box">
        <div class="info-text">
            <h3>Informations article</h3>
            <p><strong>Code :</strong> <span id="result">Aucun</span></p>
            <p><strong>Description :</strong> <span id="description">En attente...</span></p>
            <p><strong>Prix :</strong> <span id="price">En attente...</span></p>
        </div>
        <button class="btn btn-warning" onclick="restartScanner()">RedÃ©marrer</button>
    </div>
</div>

<script>
function startScanner() {
    Quagga.init({
        inputStream: {
            name: "Live",
            type: "LiveStream",
            target: document.querySelector("#camera"),
            constraints: { facingMode: "environment" }
        },
        decoder: { readers: ["ean_reader"] },
        locate: true
    }, err => { if (err) return console.error(err); Quagga.start(); });

    Quagga.onDetected(res => {
        const code = res.codeResult.code;
        result.textContent = code;
        if (code.length === 13) fetchItem(code);
    });
}

function restartScanner() {
    Quagga.stop();
    result.textContent = "Aucun";
    description.textContent = "En attente...";
    price.textContent = "En attente...";
    startScanner();
}

function fetchItem(code) {
    fetch("/api/article", {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body: "codeBarre=" + code
    })
    .then(r => r.json())
    .then(data => {
        if (data.message === "OK") {
            description.textContent = data.results.designation;
            price.textContent = data.results.prix + " â‚¬";
        } else {
            description.textContent = "Article non trouvÃ©";
            price.textContent = "N/A";
        }
    })
    .catch(() => {
        description.textContent = "Erreur serveur";
        price.textContent = "N/A";
    });
}

startScanner();
</script>

</body>
</html>
