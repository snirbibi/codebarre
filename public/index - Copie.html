<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8">
		<title>Scanner EAN-13 Optimis√©</title>

		<!-- jQuery -->
		<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

		<!-- Quagga2 (fork moderne) -->
		<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

		<!-- Bootstrap -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

		<style> 
			#camera {
				position: relative;  /* essentiel */
				width: 100%;
				height: 500px;       /* ou ce que tu veux */
				overflow: hidden;    /* emp√™che les d√©bordements ‚Üí emp√™che le d√©calage */
			}

			.header-title {
				text-align: center;
				margin: 20px 0;
			}
			.icon-scan {
				font-size: 50px;
				color: #0d6efd;
			}
			img {
				height : 40px;
			}
			.info-box { padding:20px; background:#f8f9fa; border-radius:8px; transition: all 0.5s ease;}
			.fade-in { animation: fadeIn 0.5s; }
			@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
			#result { font-size:22px; font-weight:bold; color:#007bff; }				
		</style>

		<script>
		/* mon gestionnaire d'√©v√©nements	*/
		$(document).ready(function() {
			startScanner();
			$("#restartBtn").click(restartScanner);
		});
		
		/* des fonctions javascript***/
		function startScanner() {
			const config = {
				inputStream: {
					name: "Live",
					type: "LiveStream",
					target: document.querySelector("#camera"),
					constraints: {
						facingMode: "environment",
						width: { min: 640, ideal: 1280 },
						height: { min: 480, ideal: 720 },
						aspectRatio: { min: 1, max: 2 }
					}
				},
				decoder: {
					readers: ["ean_reader"] // lecture EAN-13
				},
				locate: true // am√©liore la localisation du code-barres
			};

			Quagga.init(config, function(err) {
				if (err) {
					console.error("Erreur initialisation Quagga :", err);
					alert("Impossible d'initialiser le scanner !");
					return;
				}
				Quagga.start();
			});

			Quagga.onDetected(function(result) {
				const code = result.codeResult.code;
				$("#result").text(code).addClass("fade-in");
				getItemFromServer(code);
			});
		}

		function restartScanner() {
			Quagga.stop();
			$("#result").text("Aucun");
			$("#description").text("En attente...");
			$("#price").text("En attente...");
			startScanner();
		}

		function getItemFromServer(codeBarre) {
			$.ajax({
				url: "/api/article", // Node.js backend
				method: "POST",
				data: { codeBarre: codeBarre },
				success: function(response) {
					if (response.message === "OK") {
						$("#description").text(response.results.designation).addClass("fade-in");
						$("#price").text(response.results.prix + " ‚Ç¨").addClass("fade-in");
					} else {
						$("#description").text("Article non trouv√©");
						$("#price").text("N/A");
					}
				},
				error: function() {
					$("#description").text("Erreur serveur");
					$("#price").text("N/A");
				}
			});
		}
		</script>
	</head>

	<body>
		<div class="container">
			<!-- En-t√™te -->
			<div class="header-title">
				<div class="icon-scan">üì∑</div>
				<h1>Scanner de Codes-Barres EAN-13</h1>
				<p class="text-muted">Lyc√©e de l'Europe ‚Äì Dunkerque</p>
			</div>

			<div class="row">
				<div class="col-md-6">
					<div id="camera"></div>
				</div>

				<div class="col-md-6">
					<div class="info-box">
						<p>Code d√©tect√© : <span id="result">Aucun</span></p>
						<p>Description : <span id="description">En attente...</span></p>
						<p>Prix : <span id="price">En attente...</span></p>
					</div>
					<div class="info-box">
						<!-- Bouton red√©marrer sous l'info-box -->
						<button id="restartBtn" class="btn btn-warning mt-3">Red√©marrer Scanner</button>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
